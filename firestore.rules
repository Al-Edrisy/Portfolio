rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isDeveloper() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'developer' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    function isDeveloperOrAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['developer', 'admin'];
    }
    
    function isValidUser() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function isProjectOwner(projectId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/projects/$(projectId)) &&
        get(/databases/$(database)/documents/projects/$(projectId)).data.authorId == request.auth.uid;
    }
    
    function isProjectOwnerOrDeveloper(projectId) {
      return isProjectOwner(projectId) || isDeveloper();
    }
    
    // Users collection
    match /users/{userId} {
      // Everyone can read basic user data (for public display in comments and reactions)
      allow read: if true;
      
      // Users can create their own document, developers can create any
      allow create: if isOwner(userId) || isDeveloper();
      
      // Users can update their own data (except role), developers can update any
      allow update: if (isOwner(userId) && 
                       !('role' in request.resource.data.diff(resource.data).affectedKeys())) ||
                      isDeveloper();
      
      // Users can delete their own account, developers can delete any
      allow delete: if isOwner(userId) || isDeveloper();
    }
    
    // Projects collection
    match /projects/{projectId} {
      // Everyone can read published projects (no authentication required), developers can read all
      allow read: if resource.data.published == true || 
                     (isAuthenticated() && isProjectOwner(projectId)) || 
                     (isAuthenticated() && isDeveloper());
      
      // Developers can create projects
      allow create: if isDeveloper() && request.resource.data.authorId == request.auth.uid;
      
      // Project owners can update their own projects, developers can update any
      // Anyone can increment viewsCount (for tracking views)
      allow update: if isProjectOwnerOrDeveloper(projectId) ||
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewsCount']));
      
      // Project owners can delete their own projects, developers can delete any
      allow delete: if isProjectOwnerOrDeveloper(projectId);
    }
    
    // Reactions collection
    match /reactions/{reactionId} {
      // Everyone can read reactions (for published projects), authenticated users can read all
      allow read: if true;
      
      // Users can create reactions for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.type in ['like', 'love', 'fire', 'wow', 'laugh', 'idea', 'rocket', 'clap'];
      
      // Users can delete their own reactions
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // No updates allowed for reactions
      allow update: if false;
    }
    
    // Comments collection
    match /comments/{commentId} {
      // Everyone can read comments
      allow read: if true;
      
      // Any authenticated user can create comments
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Users can update their own comments, developers can update any
      allow update: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid || isDeveloperOrAdmin());
      
      // Users can delete their own comments, developers can delete any
      // Allow deletion if user is authenticated and either owns the comment or is a developer
      // Also allow deletion if user document doesn't exist yet (new users)
      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid || 
                        isDeveloperOrAdmin() ||
                        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) == false));
    }
    
    // Feedback collection
    match /feedback/{feedbackId} {
      // Public: Everyone can read all feedback (no authentication required)
      allow read: if true;
      
      // Only authenticated users can create feedback
      // The one-time check is also enforced in the application layer
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.rating >= 1 &&
                       request.resource.data.rating <= 6 &&
                       request.resource.data.comment.size() >= 10 &&
                       request.resource.data.comment.size() <= 500;
      
      // Only developers can update feedback (for moderation)
      allow update: if isDeveloper();
      
      // Only developers can delete feedback
      allow delete: if isDeveloper();
    }
    
    // Views collection (for tracking unique project views)
    match /views/{viewId} {
      // Everyone can read views (for analytics)
      allow read: if true;
      
      // Anyone can create a view record (authenticated or anonymous)
      allow create: if true;
      
      // No updates or deletes allowed
      allow update, delete: if false;
    }
    
    // Contacts collection (from contact form)
    match /contacts/{contactId} {
      // Only developers can read contacts
      allow read: if isDeveloper();
      
      // Anyone can create a contact submission (no authentication required for contact form)
      allow create: if true;
      
      // Only developers can update contacts (to mark as read/replied)
      allow update: if isDeveloper();
      
      // Only developers can delete contacts
      allow delete: if isDeveloper();
    }
    
    // Device locations collection (for phone recovery)
    match /device_locations/{locationId} {
      // Only developers can read location data
      allow read: if isDeveloper();
      
      // Anyone can create location records (for tracking purposes)
      allow create: if true;
      
      // No updates allowed (location data should be immutable)
      allow update: if false;
      
      // Only developers can delete location records
      allow delete: if isDeveloper();
    }
    
    // Developer-only collections (for management)
    match /admin/{document=**} {
      allow read, write: if isDeveloper();
    }
    
    // Analytics collection (read-only for users, write for developers)
    match /analytics/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isDeveloper();
    }
  }
}
