rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isDeveloper() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'developer';
    }
    
    function isAdminOrDeveloper() {
      return isAdmin() || isDeveloper();
    }
    
    function isValidUser() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function isProjectOwner(projectId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/projects/$(projectId)) &&
        get(/databases/$(database)/documents/projects/$(projectId)).data.authorId == request.auth.uid;
    }
    
    function isProjectOwnerOrAdmin(projectId) {
      return isProjectOwner(projectId) || isAdmin();
    }
    
    // Users collection
    match /users/{userId} {
      // Everyone can read basic user data (for public display in comments and reactions), users can read their own data, admins can read all
      allow read: if true;
      
      // Users can create their own document, admins can create any
      allow create: if isOwner(userId) || isAdmin();
      
      // Users can update their own data (except role), admins can update any
      allow update: if (isOwner(userId) && 
                       !('role' in request.resource.data.diff(resource.data).affectedKeys())) ||
                      isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Projects collection
    match /projects/{projectId} {
      // Everyone can read published projects (no authentication required), developers can read their own (published/unpublished), admins can read all
      allow read: if resource.data.published == true || 
                     (isAuthenticated() && isProjectOwner(projectId)) || 
                     (isAuthenticated() && isAdmin());
      
      // Developers can create their own projects, admins can create any
      allow create: if isAdminOrDeveloper() && 
                       (isAdmin() || request.resource.data.authorId == request.auth.uid);
      
      // Project owners can update their own projects, admins can update any
      // Anyone can increment viewsCount (for tracking views)
      allow update: if isProjectOwnerOrAdmin(projectId) ||
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewsCount']));
      
      // Project owners can delete their own projects, admins can delete any
      allow delete: if isProjectOwnerOrAdmin(projectId);
    }
    
    // Reactions collection
    match /reactions/{reactionId} {
      // Everyone can read reactions (for published projects), authenticated users can read all
      allow read: if true;
      
      // Users can create reactions for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.type in ['like', 'love', 'fire', 'wow', 'laugh', 'idea', 'rocket', 'clap'];
      
      // Users can delete their own reactions
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // No updates allowed for reactions
      allow update: if false;
    }
    
    // Comments collection
    match /comments/{commentId} {
      // Everyone can read comments (for published projects), authenticated users can read all
      allow read: if true;
      
      // Users can create comments for themselves - simplified validation
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.content.size() <= 1000;
      
      // Users can update their own comments (content only)
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content', 'updatedAt', 'likesCount', 'repliesCount', 'userLikes']);
      
      // Users can delete their own comments, admins can delete any
      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Views collection (for tracking unique project views)
    match /views/{viewId} {
      // Everyone can read views (for analytics)
      allow read: if true;
      
      // Anyone can create a view record (authenticated or anonymous)
      allow create: if true;
      
      // No updates or deletes allowed
      allow update, delete: if false;
    }
    
    // Admin-only collections (for future use)
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Analytics collection (read-only for users, write for admins)
    match /analytics/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
